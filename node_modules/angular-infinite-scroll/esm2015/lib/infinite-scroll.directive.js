/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Directive, Input, IterableDiffers } from '@angular/core';
import { NgZone, TemplateRef, ViewContainerRef } from '@angular/core';
import { DEFAULTS } from './defaults';
import { InfiniteScroll } from './infinite-scroll';
/**
 * @template T
 */
export class InfiniteScrollDirective extends InfiniteScroll {
    /**
     * @param {?} viewContainer
     * @param {?} templateRef
     * @param {?} differs
     * @param {?} zone
     */
    constructor(viewContainer, templateRef, differs, zone) {
        super(differs, zone);
        this._positionInitial = DEFAULTS.POSITION;
        this._dummies = 0;
        this._outOfItems = false;
        this.step = DEFAULTS.STEP;
        this.offset = DEFAULTS.OFFSET;
        this.delay = DEFAULTS.DELAY;
        this.createNgFor(viewContainer, templateRef);
    }
    /**
     * @param {?} infiniteScrollOf
     * @return {?}
     */
    set infiniteScrollOf(infiniteScrollOf) {
        if (infiniteScrollOf) {
            this._items = Array.from(infiniteScrollOf);
        }
        this.position = this._positionInitial;
        this._dummies = 0;
        this.updateItems();
        this.update();
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    set infiniteScrollTrackBy(fn) {
        this._ngFor.ngForTrackBy = fn;
    }
    /**
     * @return {?}
     */
    get infiniteScrollTrackBy() {
        return this._ngFor.ngForTrackBy;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set infiniteScrollTemplate(value) {
        this._ngFor.ngForTemplate = value;
    }
    /**
     * @param {?} position
     * @return {?}
     */
    set infiniteScrollPosition(position) {
        if (position === undefined || position === null) {
            this.position = DEFAULTS.POSITION;
        }
        else {
            this.position = position;
        }
        this._positionInitial = position;
    }
    /**
     * @param {?} loading
     * @return {?}
     */
    set infiniteScrollLoading(loading) {
        this.subscribeLoading(loading);
    }
    /**
     * @param {?} scrollEnd
     * @return {?}
     */
    set infiniteScrollEnd(scrollEnd) {
        this.subscribeEnd(scrollEnd);
    }
    /**
     * @return {?}
     */
    update() {
        if (!this._items) {
            this._items = [];
        }
        if (this._items && (!this._items.length || this._items.every((item) => item === undefined))) {
            this._items = [];
            this.addDummies();
            this.updateItems();
        }
        if (this.position < this._items.length - this._dummies) {
            this.loading$.next(true);
            this.updateItems();
            this._updateAfterRender$.next();
            this.position += this.step;
        }
        else if (this._subscriptionEnd) {
            this.loading$.next(true);
            this._end$.next();
            this.position += this.step;
            this.addDummies();
            this.updateItems();
        }
    }
    /**
     * @param {?} newItems
     * @return {?}
     */
    newItems(newItems) {
        while (this._dummies > 0) {
            if (this._items.length) {
                this._items.pop();
            }
            this._dummies--;
        }
        /** @type {?} */
        const newItemsArray = Array.from(newItems);
        this._items = this._items.concat(newItemsArray);
        this.updateItems();
        // only continue when newItems arrive
        if (newItemsArray.length) {
            this._updateAfterRender$.next();
        }
        else {
            this._outOfItems = true;
        }
    }
    /**
     * @return {?}
     */
    updateItems() {
        this.zone.run(() => {
            if (this._items) {
                // update ngForOf<T> directive
                this._ngFor.ngForOf = this._items.slice(0, this.position);
            }
        });
    }
    /**
     * @return {?}
     */
    addDummies() {
        if (!this._dummies && !this._outOfItems) {
            this._items = this._items.concat(Array(this.step).fill(undefined));
            this._dummies += this.step;
        }
    }
}
InfiniteScrollDirective.decorators = [
    { type: Directive, args: [{ selector: '[infiniteScroll]' },] },
];
/** @nocollapse */
InfiniteScrollDirective.ctorParameters = () => [
    { type: ViewContainerRef },
    { type: TemplateRef },
    { type: IterableDiffers },
    { type: NgZone }
];
InfiniteScrollDirective.propDecorators = {
    infiniteScrollOf: [{ type: Input }],
    infiniteScrollTrackBy: [{ type: Input }],
    infiniteScrollTemplate: [{ type: Input }],
    infiniteScrollPosition: [{ type: Input }],
    step: [{ type: Input, args: ['infiniteScrollStep',] }],
    offset: [{ type: Input, args: ['infiniteScrollOffset',] }],
    delay: [{ type: Input, args: ['infiniteScrollDelay',] }],
    infiniteScrollLoading: [{ type: Input }],
    infiniteScrollEnd: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    InfiniteScrollDirective.prototype._items;
    /** @type {?} */
    InfiniteScrollDirective.prototype._positionInitial;
    /** @type {?} */
    InfiniteScrollDirective.prototype._dummies;
    /** @type {?} */
    InfiniteScrollDirective.prototype._outOfItems;
    /** @type {?} */
    InfiniteScrollDirective.prototype.step;
    /** @type {?} */
    InfiniteScrollDirective.prototype.offset;
    /** @type {?} */
    InfiniteScrollDirective.prototype.delay;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5maW5pdGUtc2Nyb2xsLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItaW5maW5pdGUtc2Nyb2xsLyIsInNvdXJjZXMiOlsibGliL2luZmluaXRlLXNjcm9sbC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBZ0MsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFDLE1BQU0sRUFBRSxXQUFXLEVBQW1CLGdCQUFnQixFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXJGLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLG1CQUFtQixDQUFDOzs7O0FBR2pELE1BQU0sOEJBQWtDLFNBQVEsY0FBaUI7Ozs7Ozs7SUFPL0QsWUFBWSxhQUErQixFQUFFLFdBQTJDLEVBQUUsT0FBd0IsRUFBRSxJQUFZO1FBQzlILEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0NBTkksUUFBUSxDQUFDLFFBQVE7d0JBRXpCLENBQUM7MkJBQ0UsS0FBSztvQkF1Q1MsUUFBUSxDQUFDLElBQUk7c0JBQ1QsUUFBUSxDQUFDLE1BQU07cUJBQ2pCLFFBQVEsQ0FBQyxLQUFLO1FBckNsRCxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztLQUM5Qzs7Ozs7SUFFRCxJQUNJLGdCQUFnQixDQUFDLGdCQUErQjtRQUNsRCxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDNUM7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUN0QyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FB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QUM7U0FDNUI7Ozs7WUFsSEosU0FBUyxTQUFDLEVBQUMsUUFBUSxFQUFFLGtCQUFrQixFQUFDOzs7O1lBTEssZ0JBQWdCO1lBQTlDLFdBQVc7WUFERCxlQUFlO1lBQ2pDLE1BQU07OzsrQkFrQlgsS0FBSztvQ0FVTCxLQUFLO3FDQVFMLEtBQUs7cUNBS0wsS0FBSzttQkFTTCxLQUFLLFNBQUMsb0JBQW9CO3FCQUMxQixLQUFLLFNBQUMsc0JBQXNCO29CQUM1QixLQUFLLFNBQUMscUJBQXFCO29DQUMzQixLQUFLO2dDQUlMLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge05nRm9yT2ZDb250ZXh0fSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQge0RpcmVjdGl2ZSwgSW5wdXQsIEl0ZXJhYmxlRGlmZmVycywgTmdJdGVyYWJsZSwgT25EZXN0cm95LCBPbkluaXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge05nWm9uZSwgVGVtcGxhdGVSZWYsIFRyYWNrQnlGdW5jdGlvbiwgVmlld0NvbnRhaW5lclJlZn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7REVGQVVMVFN9IGZyb20gJy4vZGVmYXVsdHMnO1xyXG5pbXBvcnQge0luZmluaXRlU2Nyb2xsfSBmcm9tICcuL2luZmluaXRlLXNjcm9sbCc7XHJcblxyXG5ARGlyZWN0aXZlKHtzZWxlY3RvcjogJ1tpbmZpbml0ZVNjcm9sbF0nfSlcclxuZXhwb3J0IGNsYXNzIEluZmluaXRlU2Nyb2xsRGlyZWN0aXZlPFQ+IGV4dGVuZHMgSW5maW5pdGVTY3JvbGw8VD4gaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgcHJpdmF0ZSBfaXRlbXM6IEFycmF5PFQ+O1xyXG4gIHByaXZhdGUgX3Bvc2l0aW9uSW5pdGlhbCA9IERFRkFVTFRTLlBPU0lUSU9OO1xyXG5cclxuICBwcml2YXRlIF9kdW1taWVzID0gMDtcclxuICBwcml2YXRlIF9vdXRPZkl0ZW1zID0gZmFsc2U7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxOZ0Zvck9mQ29udGV4dDxUPj4sIGRpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycywgem9uZTogTmdab25lKSB7XHJcbiAgICBzdXBlcihkaWZmZXJzLCB6b25lKTtcclxuICAgIHRoaXMuY3JlYXRlTmdGb3Iodmlld0NvbnRhaW5lciwgdGVtcGxhdGVSZWYpO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KClcclxuICBzZXQgaW5maW5pdGVTY3JvbGxPZihpbmZpbml0ZVNjcm9sbE9mOiBOZ0l0ZXJhYmxlPFQ+KSB7XHJcbiAgICBpZiAoaW5maW5pdGVTY3JvbGxPZikge1xyXG4gICAgICB0aGlzLl9pdGVtcyA9IEFycmF5LmZyb20oaW5maW5pdGVTY3JvbGxPZik7XHJcbiAgICB9XHJcbiAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5fcG9zaXRpb25Jbml0aWFsO1xyXG4gICAgdGhpcy5fZHVtbWllcyA9IDA7XHJcbiAgICB0aGlzLnVwZGF0ZUl0ZW1zKCk7XHJcbiAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gIH1cclxuICBASW5wdXQoKVxyXG4gIHNldCBpbmZpbml0ZVNjcm9sbFRyYWNrQnkoZm46IFRyYWNrQnlGdW5jdGlvbjxUPikge1xyXG4gICAgdGhpcy5fbmdGb3IubmdGb3JUcmFja0J5ID0gZm47XHJcbiAgfVxyXG4gIGdldCBpbmZpbml0ZVNjcm9sbFRyYWNrQnkoKTogVHJhY2tCeUZ1bmN0aW9uPFQ+IHtcclxuICAgIHJldHVybiB0aGlzLl9uZ0Zvci5uZ0ZvclRyYWNrQnk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCBpbmZpbml0ZVNjcm9sbFRlbXBsYXRlKHZhbHVlOiBUZW1wbGF0ZVJlZjxOZ0Zvck9mQ29udGV4dDxUPj4pIHtcclxuICAgIHRoaXMuX25nRm9yLm5nRm9yVGVtcGxhdGUgPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IGluZmluaXRlU2Nyb2xsUG9zaXRpb24ocG9zaXRpb24pIHtcclxuICAgIGlmIChwb3NpdGlvbiA9PT0gdW5kZWZpbmVkIHx8IHBvc2l0aW9uID09PSBudWxsKSB7XHJcbiAgICAgIHRoaXMucG9zaXRpb24gPSBERUZBVUxUUy5QT1NJVElPTjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjtcclxuICAgIH1cclxuICAgIHRoaXMuX3Bvc2l0aW9uSW5pdGlhbCA9IHBvc2l0aW9uO1xyXG4gIH1cclxuICBASW5wdXQoJ2luZmluaXRlU2Nyb2xsU3RlcCcpIHN0ZXAgPSBERUZBVUxUUy5TVEVQO1xyXG4gIEBJbnB1dCgnaW5maW5pdGVTY3JvbGxPZmZzZXQnKSBvZmZzZXQgPSBERUZBVUxUUy5PRkZTRVQ7XHJcbiAgQElucHV0KCdpbmZpbml0ZVNjcm9sbERlbGF5JykgZGVsYXkgPSBERUZBVUxUUy5ERUxBWTtcclxuICBASW5wdXQoKVxyXG4gIHNldCBpbmZpbml0ZVNjcm9sbExvYWRpbmcobG9hZGluZzogKGxvYWRpbmc6IGJvb2xlYW4pID0+IHZvaWQpIHtcclxuICAgIHRoaXMuc3Vic2NyaWJlTG9hZGluZyhsb2FkaW5nKTtcclxuICB9XHJcbiAgQElucHV0KClcclxuICBzZXQgaW5maW5pdGVTY3JvbGxFbmQoc2Nyb2xsRW5kOiAocG9zaXRpb246IG51bWJlciwgaW50ZXJ2YWw6IG51bWJlcikgPT4gT2JzZXJ2YWJsZTxOZ0l0ZXJhYmxlPFQ+Pikge1xyXG4gICAgdGhpcy5zdWJzY3JpYmVFbmQoc2Nyb2xsRW5kKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCB1cGRhdGUoKSB7XHJcbiAgICBpZiAoIXRoaXMuX2l0ZW1zKSB7XHJcbiAgICAgIHRoaXMuX2l0ZW1zID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuX2l0ZW1zICYmICghdGhpcy5faXRlbXMubGVuZ3RoIHx8IHRoaXMuX2l0ZW1zLmV2ZXJ5KChpdGVtKSA9PiBpdGVtID09PSB1bmRlZmluZWQpKSkge1xyXG4gICAgICB0aGlzLl9pdGVtcyA9IFtdO1xyXG4gICAgICB0aGlzLmFkZER1bW1pZXMoKTtcclxuICAgICAgdGhpcy51cGRhdGVJdGVtcygpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnBvc2l0aW9uIDwgdGhpcy5faXRlbXMubGVuZ3RoIC0gdGhpcy5fZHVtbWllcykge1xyXG4gICAgICB0aGlzLmxvYWRpbmckLm5leHQodHJ1ZSk7XHJcbiAgICAgIHRoaXMudXBkYXRlSXRlbXMoKTtcclxuICAgICAgdGhpcy5fdXBkYXRlQWZ0ZXJSZW5kZXIkLm5leHQoKTtcclxuICAgICAgdGhpcy5wb3NpdGlvbiArPSB0aGlzLnN0ZXA7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3N1YnNjcmlwdGlvbkVuZCkge1xyXG4gICAgICB0aGlzLmxvYWRpbmckLm5leHQodHJ1ZSk7XHJcbiAgICAgIHRoaXMuX2VuZCQubmV4dCgpO1xyXG4gICAgICB0aGlzLnBvc2l0aW9uICs9IHRoaXMuc3RlcDtcclxuICAgICAgdGhpcy5hZGREdW1taWVzKCk7XHJcbiAgICAgIHRoaXMudXBkYXRlSXRlbXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBuZXdJdGVtcyhuZXdJdGVtczogTmdJdGVyYWJsZTxUPikge1xyXG4gICAgd2hpbGUgKHRoaXMuX2R1bW1pZXMgPiAwKSB7XHJcbiAgICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICB0aGlzLl9pdGVtcy5wb3AoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLl9kdW1taWVzLS07XHJcbiAgICB9XHJcbiAgICBjb25zdCBuZXdJdGVtc0FycmF5ID0gQXJyYXkuZnJvbShuZXdJdGVtcyk7XHJcbiAgICB0aGlzLl9pdGVtcyA9IHRoaXMuX2l0ZW1zLmNvbmNhdChuZXdJdGVtc0FycmF5KTtcclxuICAgIHRoaXMudXBkYXRlSXRlbXMoKTtcclxuICAgIC8vIG9ubHkgY29udGludWUgd2hlbiBuZXdJdGVtcyBhcnJpdmVcclxuICAgIGlmIChuZXdJdGVtc0FycmF5Lmxlbmd0aCkge1xyXG4gICAgICB0aGlzLl91cGRhdGVBZnRlclJlbmRlciQubmV4dCgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5fb3V0T2ZJdGVtcyA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVJdGVtcygpIHtcclxuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5faXRlbXMpIHtcclxuICAgICAgICAvLyB1cGRhdGUgbmdGb3JPZjxUPiBkaXJlY3RpdmVcclxuICAgICAgICB0aGlzLl9uZ0Zvci5uZ0Zvck9mID0gdGhpcy5faXRlbXMuc2xpY2UoMCwgdGhpcy5wb3NpdGlvbik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhZGREdW1taWVzKCkge1xyXG4gICAgaWYgKCF0aGlzLl9kdW1taWVzICYmICF0aGlzLl9vdXRPZkl0ZW1zKSB7XHJcbiAgICAgIHRoaXMuX2l0ZW1zID0gdGhpcy5faXRlbXMuY29uY2F0KEFycmF5KHRoaXMuc3RlcCkuZmlsbCh1bmRlZmluZWQpKTtcclxuICAgICAgdGhpcy5fZHVtbWllcyArPSB0aGlzLnN0ZXA7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==